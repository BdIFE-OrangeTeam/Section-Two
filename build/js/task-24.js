'use strict';

function $(el) {
  return document.querySelector(el);
}

function BTree(el) {
  this._isRunning = false;
  this._root = document.querySelector(el);
  this._index = 0;
  this._steps = [];
  this._it = undefined;
}

BTree.prototype = {
  constructor: BTree,

  // 根据选择的遍历方法遍历
  traverse: function traverse(process, method, beginNode) {
    method = method || 'preOrder';
    beginNode = beginNode || this._root;

    // 前序遍历
    function preOrder(node) {
      if (node === null) return;

      process.call(this, node);

      // 这是二叉树与多叉树的区别: 多个子节点
      Array.prototype.forEach.call(node.children, function (e) {
        preOrder(e);
      });
    }

    function inOrder(node) {
      if (node === null) return;

      // 这是二叉树与多叉树的区别: 多个子节点
      Array.prototype.forEach.call(node.children, function (e) {
        postOrder(e);
      });

      process.call(this, node);
    }

    // 后序遍历
    function postOrder(node) {
      if (node === null) return;

      // 这是二叉树与多叉树的区别: 多个子节点
      Array.prototype.forEach.call(node.children, function (e) {
        postOrder(e);
      });

      process.call(this, node);
    }

    switch (method) {
      case 'preOrder':
        // preOrder(this._root);
        preOrder(beginNode);
        break;
      case 'inOrder':
        // inOrder(this._root);
        inOrder(beginNode);
        break;
      case 'postOrder':
        // postOrder(this._root);
        postOrder(beginNode);
        break;
    }
  },

  add: function add(addedNode, startNode) {
    this.clear(); // reset all style

    startNode = startNode || this._root; // startNode will not be null

    startNode.appendChild(addedNode);
  },

  contains: function contains(node, startNode) {
    startNode = startNode || this._root;
    var found = false;

    this.traverse(function (enode) {
      if (enode === node) {
        found = true;
      }
    });

    return found;
  },

  clear: function clear() {
    this.traverse(function (node) {
      node.style.backgroundColor = "#FFF";
    });
  },

  remove: function remove(startNode) {
    // 只能用后序遍历删除节点
    this.traverse(function (node) {
      node.parentNode.removeChild(node); // parentNode and parentElement
    }, 'postOrder', startNode);
  },

  toArray: function toArray(method) {
    var _ = [];
    this.traverse(function (node) {
      _.push(node);
    }, method);
    return _;
  },

  init: function init(method) {
    this._steps = this.toArray(method);
  },

  run: function run(method, speed, callback) {
    if (this._isRunning) return;

    this._isRunning = true;

    var self = this;
    this._it = setInterval(cycle(), speed || 1000);

    // 闭包
    // cycle 函数只被执行一次
    function cycle() {
      var index = 0;
      var _ = self.toArray(method);
      // var _ = self._steps;

      return function () {
        if (index === _.length) {
          clearInterval(self._it);
          self._it = undefined;
          self._isRunning = false;
          callback();
        }

        if (index !== 0) _[index - 1].style.backgroundColor = '#FFF';

        if (index != _.length) _[index].style.backgroundColor = '#000';

        index += 1;
      };
    }
  },

  stop: function stop() {
    this.clear();
    this._index = 0; // reset index

    if (this._it) {
      this._isRunning = false;
      clearInterval(this._it);
      this._it = undefined;
    }
  },

  next: function next(method, callback) {
    this._steps = this.toArray(method);
    if (this._index !== 0) this._steps[this._index - 1].style.backgroundColor = "#FFF";

    if (this._index !== this._steps.length) {
      this._steps[this._index++].style.backgroundColor = "#000";
    } else {
      this._index = 0; // reset index
      callback();
    }
  },

  search: function search(method, callback) {
    this.traverse(callback, method);
  }
};

// 实际操作
function Tree() {
  var oo = new BTree(".container");
  var targetNode;

  function reset() {
    if ($(".btn.stop")) {
      $(".btn.stop").innerText = '运行';
      $(".btn.stop").className = 'btn run';
      $(".btn.debug").innerText = '单步调试';
    }
  }

  function getMethod() {
    var _options = $('#method').children;
    return Array.prototype.filter.call(_options, function (e) {
      if (e.selected) return e.value;
    })[0].value;
  }

  function getSearchText() {
    return $("#search-text").value.trim();
  }

  function getNewNodeText() {
    return $("#add-text").value.trim();
  }

  function setState() {
    var delBtn = $(".btn.delete");
    var addNodeInput = $("#add-text");
    var addBtn = $(".btn.add");

    this.enable = function () {
      delBtn.disabled = "";
      addNodeInput.disabled = "";
      addBtn.disabled = "";
    };

    this.disable = function () {
      delBtn.disabled = "disabled";
      addNodeInput.disabled = "disabled";
      addBtn.disabled = "disabled";
    };

    return this;
  }

  return {
    run: function run(el) {
      $(".btn.debug").disabled = "disabled";
      el.innerText = "停止";
      el.className = "btn stop";
      oo.run(getMethod(), 1000, function () {
        $(".btn.debug").disabled = "";
        el.innerText = "运行";
      });
    },
    stop: function stop(el) {
      $(".btn.debug").disabled = "";
      el.innerText = "运行";
      el.className = "btn run";
      $(".btn.debug").innerText = "单步调试";
      oo.stop();
    },
    debug: function debug(el) {
      if ($(".btn.run")) {
        el.innerText = '下一步';
        $(".btn.run").innerText = "停止";
        $(".btn.run").className = "btn stop";
      }
      oo.next(getMethod(), function () {
        el.innerText = '单步调试';
      });
    },
    search: function search() {
      var searchText = getSearchText();
      if (!searchText) return;

      var found = false;
      oo.clear();

      oo.search(getMethod(), function (node) {
        if (node.childNodes[0].textContent.trim() === searchText) {
          node.style.backgroundColor = 'rgb(241, 100, 100)';
          found = true;
          // node.style.border = "none";
          // node.style.boxShadow = "2px 2px 2px rgba(0, 0, 0, 0.50)";
          // node.style.color = "#FFF";
        }
      });

      if (!found) alert('表中不存在: ' + searchText);
    },
    // 选择节点: 只有选择父节点中的节点才能删除和添加
    target: function target(el) {

      if (oo.contains(el)) {
        oo.clear();
        targetNode = el;
        el.style.backgroundColor = '#F00';
        new setState().enable();
      } else if (el.id != 'add-text') {
        new setState().disable();
        oo.clear();
      }
    },
    delete: function _delete() {
      if (targetNode) {
        oo.remove(targetNode); // // 禁用删除和增加按钮
        new setState().disable();
      }
    },
    add: function add() {
      if (targetNode) {
        new setState().disable(); // 禁用删除和增加按钮
        var _newNode = document.createElement('div');
        _newNode.className = "node new";
        _newNode.innerText = getNewNodeText();
        _newNode.style.backgroundColor = "#0F0";
        oo.add(_newNode, targetNode);
      }
    }
  };
}

var treeObj = Tree();

addEventListener("click", function (e) {
  e = e || window.event;
  var el = e.srcElement || e.target;

  switch (el.className) {
    case 'btn run':
      treeObj.run(el);
      break;
    case 'btn stop':
      treeObj.stop(el);
      break;
    case 'btn debug':
      treeObj.debug(el);
      break;
    case 'methods':
      treeObj.stop($(".btn.stop") || $(".btn.run"));
      // reset();
      break;
    case 'btn search':
      treeObj.search();
      break;
    case 'btn delete':
      treeObj.delete();
      break;
    case 'btn add':
      treeObj.add();
      break;
    default:
      treeObj.target(el);
      break;
  }
});
//# sourceMappingURL=data:application/json;base64,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QUFwQkY7QUF3QkksY0FBUSxNQUFSLENBQWUsRUFBZixFQURGO0FBRUUsWUFGRjtBQXZCRixHQUpxQztDQUFiLENBQTFCIiwiZmlsZSI6InRhc2stMjQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJmdW5jdGlvbiAkIChlbCkge1xuICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlbCk7XG59XG5cbmZ1bmN0aW9uIEJUcmVlKGVsKSB7XG4gIHRoaXMuX2lzUnVubmluZyA9IGZhbHNlO1xuICB0aGlzLl9yb290ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlbCk7XG4gIHRoaXMuX2luZGV4ID0gMDtcbiAgdGhpcy5fc3RlcHMgPSBbXTtcbiAgdGhpcy5faXQgPSB1bmRlZmluZWQ7XG59XG5cbkJUcmVlLnByb3RvdHlwZSA9IHtcbiAgY29uc3RydWN0b3I6IEJUcmVlLFxuXG4gIC8vIOagueaNrumAieaLqeeahOmBjeWOhuaWueazlemBjeWOhlxuICB0cmF2ZXJzZTogZnVuY3Rpb24gKHByb2Nlc3MsIG1ldGhvZCwgYmVnaW5Ob2RlKSB7XG4gICAgbWV0aG9kID0gbWV0aG9kIHx8ICdwcmVPcmRlcic7XG4gICAgYmVnaW5Ob2RlID0gYmVnaW5Ob2RlIHx8IHRoaXMuX3Jvb3Q7XG5cbiAgICAvLyDliY3luo/pgY3ljoZcbiAgICBmdW5jdGlvbiBwcmVPcmRlcihub2RlKSB7XG4gICAgICBpZiAobm9kZSA9PT0gbnVsbCkgcmV0dXJuIDtcblxuICAgICAgcHJvY2Vzcy5jYWxsKHRoaXMsIG5vZGUpO1xuXG4gICAgICAvLyDov5nmmK/kuozlj4nmoJHkuI7lpJrlj4nmoJHnmoTljLrliKs6IOWkmuS4quWtkOiKgueCuVxuICAgICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChub2RlLmNoaWxkcmVuLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBwcmVPcmRlcihlKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGluT3JkZXIobm9kZSkge1xuICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHJldHVybiA7XG5cbiAgICAgIC8vIOi/meaYr+S6jOWPieagkeS4juWkmuWPieagkeeahOWMuuWIqzog5aSa5Liq5a2Q6IqC54K5XG4gICAgICBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKG5vZGUuY2hpbGRyZW4sIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIHBvc3RPcmRlcihlKTtcbiAgICAgIH0pO1xuXG4gICAgICBwcm9jZXNzLmNhbGwodGhpcywgbm9kZSk7XG4gICAgfVxuXG4gICAgLy8g5ZCO5bqP6YGN5Y6GXG4gICAgZnVuY3Rpb24gcG9zdE9yZGVyKG5vZGUpIHtcbiAgICAgIGlmIChub2RlID09PSBudWxsKSByZXR1cm4gO1xuXG4gICAgICAvLyDov5nmmK/kuozlj4nmoJHkuI7lpJrlj4nmoJHnmoTljLrliKs6IOWkmuS4quWtkOiKgueCuVxuICAgICAgQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbChub2RlLmNoaWxkcmVuLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICBwb3N0T3JkZXIoZSk7XG4gICAgICB9KTtcblxuICAgICAgcHJvY2Vzcy5jYWxsKHRoaXMsIG5vZGUpO1xuICAgIH1cblxuICAgIHN3aXRjaChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ3ByZU9yZGVyJzpcbiAgICAgICAgLy8gcHJlT3JkZXIodGhpcy5fcm9vdCk7XG4gICAgICAgIHByZU9yZGVyKGJlZ2luTm9kZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnaW5PcmRlcic6XG4gICAgICAgIC8vIGluT3JkZXIodGhpcy5fcm9vdCk7XG4gICAgICAgIGluT3JkZXIoYmVnaW5Ob2RlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdwb3N0T3JkZXInOlxuICAgICAgICAvLyBwb3N0T3JkZXIodGhpcy5fcm9vdCk7XG4gICAgICAgIHBvc3RPcmRlcihiZWdpbk5vZGUpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH0sXG5cbiAgYWRkOiBmdW5jdGlvbiAoYWRkZWROb2RlLCBzdGFydE5vZGUpIHtcbiAgICB0aGlzLmNsZWFyKCk7IC8vIHJlc2V0IGFsbCBzdHlsZVxuXG4gICAgc3RhcnROb2RlID0gc3RhcnROb2RlIHx8IHRoaXMuX3Jvb3Q7IC8vIHN0YXJ0Tm9kZSB3aWxsIG5vdCBiZSBudWxsXG5cbiAgICBzdGFydE5vZGUuYXBwZW5kQ2hpbGQoYWRkZWROb2RlKTtcbiAgfSxcblxuICBjb250YWluczogZnVuY3Rpb24gKG5vZGUsIHN0YXJ0Tm9kZSkge1xuICAgIHN0YXJ0Tm9kZSA9IHN0YXJ0Tm9kZSB8fCB0aGlzLl9yb290O1xuICAgIHZhciBmb3VuZCA9IGZhbHNlO1xuXG4gICAgdGhpcy50cmF2ZXJzZShmdW5jdGlvbiAoZW5vZGUpIHtcbiAgICAgIGlmIChlbm9kZSA9PT0gbm9kZSkge1xuICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZm91bmQ7XG4gIH0sXG5cbiAgY2xlYXI6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnRyYXZlcnNlKGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICBub2RlLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IFwiI0ZGRlwiO1xuICAgIH0pO1xuICB9LFxuXG4gIHJlbW92ZTogZnVuY3Rpb24gKHN0YXJ0Tm9kZSkge1xuICAgIC8vIOWPquiDveeUqOWQjuW6j+mBjeWOhuWIoOmZpOiKgueCuVxuICAgIHRoaXMudHJhdmVyc2UoZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsgLy8gcGFyZW50Tm9kZSBhbmQgcGFyZW50RWxlbWVudFxuICAgIH0sICdwb3N0T3JkZXInLCBzdGFydE5vZGUpO1xuICB9LFxuXG4gIHRvQXJyYXk6IGZ1bmN0aW9uIChtZXRob2QpIHtcbiAgICB2YXIgXyA9IFtdO1xuICAgIHRoaXMudHJhdmVyc2UoZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgIF8ucHVzaChub2RlKTtcbiAgICB9LCBtZXRob2QpO1xuICAgIHJldHVybiBfO1xuICB9LFxuXG4gIGluaXQ6IGZ1bmN0aW9uIChtZXRob2QpIHtcbiAgICB0aGlzLl9zdGVwcyA9IHRoaXMudG9BcnJheShtZXRob2QpO1xuICB9LFxuXG4gIHJ1bjogZnVuY3Rpb24gKG1ldGhvZCwgc3BlZWQsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHRoaXMuX2lzUnVubmluZykgcmV0dXJuIDtcblxuICAgIHRoaXMuX2lzUnVubmluZyA9IHRydWU7XG5cbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5faXQgPSBzZXRJbnRlcnZhbChjeWNsZSgpLCBzcGVlZCB8fCAxMDAwKTtcblxuICAgIC8vIOmXreWMhVxuICAgIC8vIGN5Y2xlIOWHveaVsOWPquiiq+aJp+ihjOS4gOasoVxuICAgIGZ1bmN0aW9uIGN5Y2xlKCkge1xuICAgICAgdmFyIGluZGV4ID0gMDtcbiAgICAgIHZhciBfID0gc2VsZi50b0FycmF5KG1ldGhvZCk7XG4gICAgICAvLyB2YXIgXyA9IHNlbGYuX3N0ZXBzO1xuXG4gICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoaW5kZXggPT09IF8ubGVuZ3RoKSB7XG4gICAgICAgICAgY2xlYXJJbnRlcnZhbChzZWxmLl9pdCk7XG4gICAgICAgICAgc2VsZi5faXQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgc2VsZi5faXNSdW5uaW5nID0gZmFsc2U7XG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbmRleCAhPT0gMClcbiAgICAgICAgICBfW2luZGV4LTFdLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICcjRkZGJztcblxuICAgICAgICBpZiAoaW5kZXggIT0gXy5sZW5ndGgpXG4gICAgICAgIF9baW5kZXhdLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICcjMDAwJztcblxuICAgICAgICBpbmRleCArPSAxO1xuICAgICAgfTtcbiAgICB9XG4gIH0sXG5cbiAgc3RvcDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuY2xlYXIoKTtcbiAgICB0aGlzLl9pbmRleCA9IDA7IC8vIHJlc2V0IGluZGV4XG5cbiAgICBpZiAodGhpcy5faXQpIHtcbiAgICAgIHRoaXMuX2lzUnVubmluZyA9IGZhbHNlO1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pdCk7XG4gICAgICB0aGlzLl9pdCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH0sXG5cbiAgbmV4dDogZnVuY3Rpb24gKG1ldGhvZCwgY2FsbGJhY2spIHtcbiAgICB0aGlzLl9zdGVwcyA9IHRoaXMudG9BcnJheShtZXRob2QpO1xuICAgIGlmICh0aGlzLl9pbmRleCAhPT0gMClcbiAgICAgIHRoaXMuX3N0ZXBzW3RoaXMuX2luZGV4LTFdLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IFwiI0ZGRlwiO1xuXG4gICAgaWYgKHRoaXMuX2luZGV4ICE9PSB0aGlzLl9zdGVwcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuX3N0ZXBzW3RoaXMuX2luZGV4KytdLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IFwiIzAwMFwiO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbmRleCA9IDA7IC8vIHJlc2V0IGluZGV4XG4gICAgICBjYWxsYmFjaygpO1xuICAgIH1cbiAgfSxcblxuICBzZWFyY2g6IGZ1bmN0aW9uIChtZXRob2QsIGNhbGxiYWNrKSB7XG4gICAgdGhpcy50cmF2ZXJzZShjYWxsYmFjaywgbWV0aG9kKTtcbiAgfSxcbn07XG5cbi8vIOWunumZheaTjeS9nFxuZnVuY3Rpb24gVHJlZSgpIHtcbiAgICB2YXIgb28gPSBuZXcgQlRyZWUoXCIuY29udGFpbmVyXCIpO1xuICAgIHZhciB0YXJnZXROb2RlO1xuXG4gICAgZnVuY3Rpb24gcmVzZXQoKSB7XG4gICAgICBpZiAoJChcIi5idG4uc3RvcFwiKSkge1xuICAgICAgICAkKFwiLmJ0bi5zdG9wXCIpLmlubmVyVGV4dCA9ICfov5DooYwnO1xuICAgICAgICAkKFwiLmJ0bi5zdG9wXCIpLmNsYXNzTmFtZSA9ICdidG4gcnVuJztcbiAgICAgICAgJChcIi5idG4uZGVidWdcIikuaW5uZXJUZXh0ID0gJ+WNleatpeiwg+ivlSc7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0TWV0aG9kKCkge1xuICAgICAgdmFyIF9vcHRpb25zID0gJCgnI21ldGhvZCcpLmNoaWxkcmVuO1xuICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChfb3B0aW9ucywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgaWYgKGUuc2VsZWN0ZWQpIHJldHVybiBlLnZhbHVlO1xuICAgICAgfSlbMF0udmFsdWU7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0U2VhcmNoVGV4dCgpIHtcbiAgICAgIHJldHVybiAkKFwiI3NlYXJjaC10ZXh0XCIpLnZhbHVlLnRyaW0oKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXROZXdOb2RlVGV4dCgpIHtcbiAgICAgIHJldHVybiAkKFwiI2FkZC10ZXh0XCIpLnZhbHVlLnRyaW0oKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRTdGF0ZSgpIHtcbiAgICAgIHZhciBkZWxCdG4gPSAkKFwiLmJ0bi5kZWxldGVcIik7XG4gICAgICB2YXIgYWRkTm9kZUlucHV0ID0gJChcIiNhZGQtdGV4dFwiKTtcbiAgICAgIHZhciBhZGRCdG4gPSAkKFwiLmJ0bi5hZGRcIik7XG5cbiAgICAgIHRoaXMuZW5hYmxlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBkZWxCdG4uZGlzYWJsZWQgPSBcIlwiO1xuICAgICAgICBhZGROb2RlSW5wdXQuZGlzYWJsZWQgPSBcIlwiO1xuICAgICAgICBhZGRCdG4uZGlzYWJsZWQgPSBcIlwiO1xuICAgICAgfTtcblxuICAgICAgdGhpcy5kaXNhYmxlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBkZWxCdG4uZGlzYWJsZWQgPSBcImRpc2FibGVkXCI7XG4gICAgICAgIGFkZE5vZGVJbnB1dC5kaXNhYmxlZCA9IFwiZGlzYWJsZWRcIjtcbiAgICAgICAgYWRkQnRuLmRpc2FibGVkID0gXCJkaXNhYmxlZFwiO1xuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJ1bjogZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICQoXCIuYnRuLmRlYnVnXCIpLmRpc2FibGVkID0gXCJkaXNhYmxlZFwiO1xuICAgICAgICBlbC5pbm5lclRleHQgPSBcIuWBnOatolwiO1xuICAgICAgICBlbC5jbGFzc05hbWUgPSBcImJ0biBzdG9wXCI7XG4gICAgICAgIG9vLnJ1bihnZXRNZXRob2QoKSwgMTAwMCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICQoXCIuYnRuLmRlYnVnXCIpLmRpc2FibGVkID0gXCJcIjtcbiAgICAgICAgICBlbC5pbm5lclRleHQgPSBcIui/kOihjFwiO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBzdG9wOiBmdW5jdGlvbiAoZWwpIHtcbiAgICAgICAgJChcIi5idG4uZGVidWdcIikuZGlzYWJsZWQgPSBcIlwiO1xuICAgICAgICBlbC5pbm5lclRleHQgPSBcIui/kOihjFwiO1xuICAgICAgICBlbC5jbGFzc05hbWUgPSBcImJ0biBydW5cIjtcbiAgICAgICAgJChcIi5idG4uZGVidWdcIikuaW5uZXJUZXh0ID0gXCLljZXmraXosIPor5VcIjtcbiAgICAgICAgb28uc3RvcCgpO1xuICAgICAgfSxcbiAgICAgIGRlYnVnOiBmdW5jdGlvbiAoZWwpIHtcbiAgICAgICAgaWYgKCQoXCIuYnRuLnJ1blwiKSkge1xuICAgICAgICAgIGVsLmlubmVyVGV4dCA9ICfkuIvkuIDmraUnO1xuICAgICAgICAgICQoXCIuYnRuLnJ1blwiKS5pbm5lclRleHQgPSBcIuWBnOatolwiO1xuICAgICAgICAgICQoXCIuYnRuLnJ1blwiKS5jbGFzc05hbWUgPSBcImJ0biBzdG9wXCI7XG4gICAgICAgIH1cbiAgICAgICAgb28ubmV4dChnZXRNZXRob2QoKSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGVsLmlubmVyVGV4dCA9ICfljZXmraXosIPor5UnO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBzZWFyY2g6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHNlYXJjaFRleHQgPSBnZXRTZWFyY2hUZXh0KCk7XG4gICAgICAgIGlmICghIHNlYXJjaFRleHQpIHJldHVybiA7XG5cbiAgICAgICAgdmFyIGZvdW5kID0gZmFsc2U7XG4gICAgICAgIG9vLmNsZWFyKCk7XG5cbiAgICAgICAgb28uc2VhcmNoKGdldE1ldGhvZCgpLCBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICAgIGlmIChub2RlLmNoaWxkTm9kZXNbMF0udGV4dENvbnRlbnQudHJpbSgpID09PSBzZWFyY2hUZXh0KSB7XG4gICAgICAgICAgICBub2RlLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICdyZ2IoMjQxLCAxMDAsIDEwMCknO1xuICAgICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgLy8gbm9kZS5zdHlsZS5ib3JkZXIgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgIC8vIG5vZGUuc3R5bGUuYm94U2hhZG93ID0gXCIycHggMnB4IDJweCByZ2JhKDAsIDAsIDAsIDAuNTApXCI7XG4gICAgICAgICAgICAvLyBub2RlLnN0eWxlLmNvbG9yID0gXCIjRkZGXCI7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoISBmb3VuZCkgYWxlcnQoYOihqOS4reS4jeWtmOWcqDogJHtzZWFyY2hUZXh0fWApO1xuICAgICAgfSxcbiAgICAgIC8vIOmAieaLqeiKgueCuTog5Y+q5pyJ6YCJ5oup54i26IqC54K55Lit55qE6IqC54K55omN6IO95Yig6Zmk5ZKM5re75YqgXG4gICAgICB0YXJnZXQ6IGZ1bmN0aW9uIChlbCkge1xuXG4gICAgICAgIGlmIChvby5jb250YWlucyhlbCkpIHtcbiAgICAgICAgICBvby5jbGVhcigpO1xuICAgICAgICAgIHRhcmdldE5vZGUgPSBlbDtcbiAgICAgICAgICBlbC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAnI0YwMCc7XG4gICAgICAgICAgbmV3IHNldFN0YXRlKCkuZW5hYmxlKCk7XG4gICAgICAgIH0gZWxzZSBpZiAoZWwuaWQgIT0gJ2FkZC10ZXh0Jyl7XG4gICAgICAgICAgbmV3IHNldFN0YXRlKCkuZGlzYWJsZSgpO1xuICAgICAgICAgIG9vLmNsZWFyKCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBkZWxldGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRhcmdldE5vZGUpIHtcbiAgICAgICAgICBvby5yZW1vdmUodGFyZ2V0Tm9kZSk7IC8vIC8vIOemgeeUqOWIoOmZpOWSjOWinuWKoOaMiemSrlxuICAgICAgICAgIG5ldyBzZXRTdGF0ZSgpLmRpc2FibGUoKTtcbiAgICAgICAgfVxuXG4gICAgICB9LFxuICAgICAgYWRkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0YXJnZXROb2RlKSB7XG4gICAgICAgICAgbmV3IHNldFN0YXRlKCkuZGlzYWJsZSgpOyAvLyDnpoHnlKjliKDpmaTlkozlop7liqDmjInpkq5cbiAgICAgICAgICB2YXIgX25ld05vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICBfbmV3Tm9kZS5jbGFzc05hbWUgPSBcIm5vZGUgbmV3XCI7XG4gICAgICAgICAgX25ld05vZGUuaW5uZXJUZXh0ID0gZ2V0TmV3Tm9kZVRleHQoKTtcbiAgICAgICAgICBfbmV3Tm9kZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBcIiMwRjBcIjtcbiAgICAgICAgICBvby5hZGQoX25ld05vZGUsIHRhcmdldE5vZGUpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH07XG59XG5cbnZhciB0cmVlT2JqID0gVHJlZSgpO1xuXG5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGUpIHtcbiAgZSA9IGUgfHwgd2luZG93LmV2ZW50O1xuICB2YXIgZWwgPSBlLnNyY0VsZW1lbnQgfHwgZS50YXJnZXQ7XG5cbiAgc3dpdGNoKGVsLmNsYXNzTmFtZSkge1xuICAgIGNhc2UgJ2J0biBydW4nOlxuICAgICAgdHJlZU9iai5ydW4oZWwpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnYnRuIHN0b3AnOlxuICAgICAgdHJlZU9iai5zdG9wKGVsKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2J0biBkZWJ1Zyc6XG4gICAgICB0cmVlT2JqLmRlYnVnKGVsKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ21ldGhvZHMnOlxuICAgICAgdHJlZU9iai5zdG9wKCQoXCIuYnRuLnN0b3BcIikgfHwgJChcIi5idG4ucnVuXCIpKTtcbiAgICAgIC8vIHJlc2V0KCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdidG4gc2VhcmNoJzpcbiAgICAgIHRyZWVPYmouc2VhcmNoKCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdidG4gZGVsZXRlJzpcbiAgICAgIHRyZWVPYmouZGVsZXRlKCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdidG4gYWRkJzpcbiAgICAgIHRyZWVPYmouYWRkKCk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgdHJlZU9iai50YXJnZXQoZWwpO1xuICAgICAgYnJlYWs7XG4gIH1cbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
